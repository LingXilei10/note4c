[细说new与malloc的10点区别 - melonstreet - 博客园](https://www.cnblogs.com/QG-whz/p/5140930.html)



在C和C++中，`malloc` 函数用于动态分配内存。`malloc` 函数从堆（heap）中分配内存空间。堆是程序运行时可以动态分配和释放的内存区域，与程序的栈（stack）和数据段（data segment）不同，堆的大小在程序运行时可以改变。

### 堆（Heap）的特点：

1. **动态分配**：堆内存的分配和释放是在程序运行时动态进行的，由程序员通过调用如 `malloc`、`free` 等函数来控制。
2. **大小可变**：堆的大小可以根据需要动态调整，操作系统负责管理堆内存的分配和回收。
3. **生命周期**：堆内存的生命周期不固定，它取决于程序中对它的分配和释放操作。
4. **碎片化**：频繁的分配和释放操作可能导致堆内存碎片化，影响内存使用效率。

### 使用 `malloc` 分配内存：

当使用 `malloc` 函数分配内存时，实际上是向操作系统请求一定大小的内存空间。如果操作系统有足够的可用内存，它会分配这块内存，并返回一个指向这块内存的指针。如果请求的内存无法满足，`malloc` 通常会返回 `NULL`（在C++中是 `nullptr`）。

```c
#include <stdlib.h>

int main() {
    int *ptr = (int *)malloc(sizeof(int) * 10); // 分配10个int大小的内存
    if (ptr == NULL) {
        // 处理内存分配失败的情况
    }

    // 使用ptr指向的内存...

    free(ptr); // 释放内存
    return 0;
}
```

### 释放堆内存：

使用 `malloc` 分配的内存需要通过 `free` 函数来释放，以避免内存泄漏。`free` 函数告诉操作系统之前分配的内存不再需要，可以被回收利用。

```c
free(ptr); // 释放ptr指向的内存
```

在现代操作系统中，堆内存的管理通常由内存管理单元（Memory Management Unit, MMU）或操作系统内核来处理，具体的内存分配策略可能会因操作系统和内存管理器的不同而有所差异。